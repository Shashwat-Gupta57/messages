<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Talken-C</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              'bipolar-dark': '#0f172a',
              'bipolar-darker': '#020617',
              'bipolar-accent': '#3b82f6',
              'chat-sent': '#005c4b',
              'chat-received': '#202c33',
              'unread-badge': '#25d366', // WhatsApp Green
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #020617;
        color: #e2e8f0;
      }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      .hide-scrollbar::-webkit-scrollbar {
          display: none;
      }
      .hide-scrollbar {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
      
      /* Animations */
      @keyframes popIn {
        0% { transform: scale(0); opacity: 0; }
        80% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
      }
      .note-bubble {
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      }

      @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .wall-post {
        animation: slideIn 0.4s ease-out forwards;
      }

      /* Modal Backdrop */
      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(4px);
      }
      
      .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Checkbox for circles */
      .custom-checkbox:checked + div {
        background-color: #059669;
        border-color: #059669;
      }
      .custom-checkbox:checked + div svg {
        display: block;
      }
    </style>
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
      }
    }
    </script>
  </head>
  <body>
    <div id="root" class="h-screen w-screen bg-black overflow-hidden relative"></div>
    
    <!-- Modals Container (Injected dynamically) -->
    <div id="modal-container"></div>

    <script type="module">
      import { initializeApp } from "firebase/app";
      import { getDatabase, ref, push, onValue, off, set, update, remove } from "firebase/database";

      // --- CONSTANTS ---
      const THEMES = {
        'classic': { name: 'Classic (Cubes)', url: 'https://www.transparenttextures.com/patterns/cubes.png' },
        'stars': { name: 'Night Sky', url: 'https://www.transparenttextures.com/patterns/stardust.png' },
        'paper': { name: 'Notebook', url: 'https://www.transparenttextures.com/patterns/notebook.png' },
        'geometric': { name: 'Geometric', url: 'https://www.transparenttextures.com/patterns/hexellence.png' },
        'wood': { name: 'Dark Wood', url: 'https://www.transparenttextures.com/patterns/wood-pattern.png' }
      };

      const PROFILE_COLORS = [
        'bg-emerald-600', 'bg-indigo-600', 'bg-blue-600', 'bg-purple-600', 
        'bg-rose-600', 'bg-orange-600', 'bg-cyan-600', 'bg-teal-600', 'bg-pink-600'
      ];

      const getWeekNumber = (d = new Date()) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
        return weekNo;
      };

      const getCurrentWeekKey = () => {
        const week = getWeekNumber();
        const year = new Date().getFullYear();
        return `week_${year}_${week}`;
      };

      const formatTime = (timestamp) => {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        const now = new Date();
        const isToday = date.getDate() === now.getDate() && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        
        if (isToday) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }
      };

      const formatMessageDate = (timestamp) => {
        return new Date(timestamp).toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
      };

      // Helper for Avatars
      const getAvatar = (user) => {
         if(!user) return 'https://ui-avatars.com/api/?name=??&background=random';
         
         const n = (user.nickname || user.name || '').toLowerCase();
         if (n.includes('shashwat')) return 'res/icon-1.png';
         if (n.includes('apoorva')) return 'res/icon-2.png';
         
         // Use existing if valid, otherwise fallback to UI Avatars for speed
         return user.avatar || `https://ui-avatars.com/api/?name=${user.name}&background=random`;
      };

      // --- FIREBASE SERVICE ---
      const firebaseConfig = {
        apiKey: "AIzaSyBIyIXYNvVhJnSK58rB29K9n7SNnbaoqnc",
        authDomain: "proposal-apoorva-sarvagy.firebaseapp.com",
        databaseURL: "https://proposal-apoorva-sarvagy-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "proposal-apoorva-sarvagy",
        storageBucket: "proposal-apoorva-sarvagy.firebasestorage.app",
        messagingSenderId: "794226715688",
        appId: "1:794226715688:web:284222db7af709b2cd591d",
        measurementId: "G-BZ4R12MR9T"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const ROOT_NODE = "messages_site";

      // 1. Send Direct Message
      const sendMessage = async (senderId, receiverId, text) => {
        const weekKey = getCurrentWeekKey();
        const timestamp = Date.now();
        const messagePayload = {
          sent_by: senderId,
          sent_to: receiverId,
          message: text,
          timestamp: timestamp
        };
        // Push to sender's "sent" box
        await push(ref(db, `${ROOT_NODE}/${senderId}/sent/${weekKey}`), messagePayload);
        // Push to receiver's "received" box
        await push(ref(db, `${ROOT_NODE}/${receiverId}/received/${weekKey}`), messagePayload);
      };

      // 2. Send Group Message
      const sendGroupMessage = async (senderId, groupId, text) => {
        const weekKey = getCurrentWeekKey();
        const timestamp = Date.now();
        const messagePayload = {
          sent_by: senderId,
          sent_to: groupId, // Using Group ID as receiver
          message: text,
          timestamp: timestamp,
          is_group: true
        };
        await push(ref(db, `${ROOT_NODE}/groups/${groupId}/messages/${weekKey}`), messagePayload);
      };

      // 3. Post to Wall
      const postToWall = async (userId, text) => {
        const postPayload = {
          user_id: userId,
          text: text,
          timestamp: Date.now()
        };
        await push(ref(db, `${ROOT_NODE}/wall`), postPayload);
      };

      // 4. Create Group (Circle)
      const createCircle = async (name, creatorId, memberIds) => {
        const groupsRef = ref(db, `${ROOT_NODE}/groups`);
        const newGroupRef = push(groupsRef);
        
        // Members must include creator
        const finalMembers = [...new Set([creatorId, ...memberIds])];
        
        const groupData = {
          id: newGroupRef.key,
          name: name,
          created_by: creatorId,
          created_at: Date.now(),
          members: finalMembers,
          avatar: `https://ui-avatars.com/api/?name=${name}&background=random&length=1`
        };
        
        await set(newGroupRef, groupData);
        return groupData;
      };

      const deleteCircle = async (groupId) => {
         await remove(ref(db, `${ROOT_NODE}/groups/${groupId}`));
      }

      const updateGroupMembers = async (groupId, newMembers) => {
         const groupRef = ref(db, `${ROOT_NODE}/groups/${groupId}`);
         await update(groupRef, { members: newMembers });
      };

      const updateGroupName = async (groupId, newName) => {
         const groupRef = ref(db, `${ROOT_NODE}/groups/${groupId}`);
         await update(groupRef, { 
             name: newName,
             avatar: `https://ui-avatars.com/api/?name=${newName}&background=random&length=1`
         });
      };

      const markAsRead = (myId, targetId) => {
        const statusRef = ref(db, `${ROOT_NODE}/status/${myId}/${targetId}/last_seen`);
        set(statusRef, Date.now());
      };

      const createNewUser = async (nickname, password) => {
         const usersRef = ref(db, `${ROOT_NODE}/users`);
         const newUserRef = push(usersRef);
         const color = PROFILE_COLORS[Math.floor(Math.random() * PROFILE_COLORS.length)];
         
         const avatarUrl = `https://ui-avatars.com/api/?name=${nickname}&background=random&bold=true`;

         const userData = {
           id: newUserRef.key,
           name: nickname, // Login name
           nickname: nickname, // Display name
           password: password, 
           avatar: avatarUrl,
           color: color,
           about: "Hey! I am new to Talken-C.",
           note: "",
           bestie_id: "",
           created_at: Date.now()
         };

         await set(newUserRef, userData);
         return userData;
      };

      const updateUserProfile = (userId, data) => {
        const userRef = ref(db, `${ROOT_NODE}/users/${userId}`);
        update(userRef, {
          ...data,
          updated_at: Date.now()
        });
      };
      
      const updateUserPreferences = (myId, targetId, prefs) => {
        const prefRef = ref(db, `${ROOT_NODE}/users/${myId}/preferences/${targetId}`);
        update(prefRef, prefs);
      };

      // --- SUBSCRIPTIONS ---

      // Global User/Group Listeners
      const subscribeToUsers = (callback) => {
        return onValue(ref(db, `${ROOT_NODE}/users`), (s) => callback(s.val() || {}));
      };
      
      const subscribeToGroups = (callback) => {
        return onValue(ref(db, `${ROOT_NODE}/groups`), (s) => callback(s.val() || {}));
      };

      const subscribeToWall = (callback) => {
        return onValue(ref(db, `${ROOT_NODE}/wall`), (snapshot) => {
          const val = snapshot.val() || {};
          const posts = Object.keys(val).map(k => ({ id: k, ...val[k] }));
          posts.sort((a, b) => b.timestamp - a.timestamp); 
          callback(posts);
        });
      };

      // Global Message Listeners (Fetch ALL for Sidebar)
      const subscribeToAllDMs = (currentUser, callback) => {
        const sentRef = ref(db, `${ROOT_NODE}/${currentUser}/sent`);
        const receivedRef = ref(db, `${ROOT_NODE}/${currentUser}/received`);
        
        let sentData = {}, receivedData = {};

        const mergeAndCallback = () => {
             callback(sentData, receivedData);
        };

        const u1 = onValue(sentRef, s => { sentData = s.val() || {}; mergeAndCallback(); });
        const u2 = onValue(receivedRef, s => { receivedData = s.val() || {}; mergeAndCallback(); });
        return () => { u1(); u2(); };
      };

      const subscribeToMyReadStatus = (myId, callback) => {
         // status/{myId}/{targetId}/last_seen
         return onValue(ref(db, `${ROOT_NODE}/status/${myId}`), (s) => callback(s.val() || {}));
      };

      // --- APP LOGIC ---
      
      let state = {
        currentUser: null,
        selectedId: null, // User ID or Group ID
        selectedType: null, // 'user' or 'group'
        currentView: 'chat', // 'chat' or 'wall'
        
        users: {}, 
        groups: {},
        wallPosts: [],
        
        // Data populated by global listeners
        chats: {},
        myReadStatus: {},
        
        // Subscription Handles
        unsubs: []
      };

      const root = document.getElementById('root');
      const modalContainer = document.getElementById('modal-container');

      // Helper: Get display name (checking Alias first)
      const getDisplayName = (userId) => {
          const user = state.users[userId];
          if(!user) return "Unknown";
          const prefs = state.currentUser.preferences?.[userId];
          return (prefs && prefs.alias) ? prefs.alias : (user.nickname || user.name);
      };

      function bootstrap() {
        const unsubUsers = subscribeToUsers((usersData) => {
          state.users = usersData;
          const savedUserId = localStorage.getItem('bipolar_user_id');
          if (!state.currentUser && savedUserId && state.users[savedUserId]) {
             handleLoginSuccess(state.users[savedUserId]);
          } else if (state.currentUser) {
             // Update self data in real time
             if (state.users[state.currentUser.id]) state.currentUser = state.users[state.currentUser.id];
             refreshUI();
          } else {
             renderLogin();
          }
        });
        state.unsubs.push(unsubUsers);
      }

      bootstrap();

      function refreshUI() {
        if (!state.currentUser) return;
        
        processMessages(); // Re-calculate unread/latest based on new data

        renderSidebarList(); // Always update sidebar

        if (state.currentView === 'chat') {
          if (!document.getElementById('messages-container')) {
             renderChatStructure(); // Initial Render
          } else if(state.selectedId) {
             // Theme might have changed, update BG
             updateChatBackground(); 
          }
          if(state.selectedId) renderChatMessages();
        } else if (state.currentView === 'wall') {
           if (!document.getElementById('wall-feed')) {
              renderWallLayout();
           }
           renderWallPosts();
        }
      }

      function processMessages() {
          if (!state.rawDMs) return;

          const chats = {};

          // 1. Process DMs
          const processMailbox = (mailbox) => {
              if(!mailbox) return;
              Object.values(mailbox).forEach(weekData => {
                  Object.values(weekData).forEach(msg => {
                      const partnerId = msg.sent_by === state.currentUser.id ? msg.sent_to : msg.sent_by;
                      if (!chats[partnerId]) chats[partnerId] = { messages: [], isGroup: false };
                      
                      chats[partnerId].messages.push({
                          text: msg.message,
                          sentBy: msg.sent_by,
                          sentTo: msg.sent_to,
                          timestamp: msg.timestamp,
                          is_group: false
                      });
                  });
              });
          };

          processMailbox(state.rawDMs.sent);
          processMailbox(state.rawDMs.received);

          // 2. Process Groups
          if (state.rawGroups) {
              Object.keys(state.rawGroups).forEach(groupId => {
                  const msgs = state.rawGroups[groupId] || [];
                  chats[groupId] = { messages: msgs, isGroup: true };
              });
          }

          // 3. Sort and Calculate Metadata
          Object.keys(chats).forEach(id => {
              const chat = chats[id];
              // Sort messages
              chat.messages.sort((a, b) => a.timestamp - b.timestamp);
              
              // Last Message
              chat.lastMessage = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1] : null;

              // Unread Count
              const myLastSeen = state.myReadStatus[id]?.last_seen || 0;
              chat.unreadCount = chat.messages.filter(m => 
                  m.sentBy !== state.currentUser.id && 
                  m.timestamp > myLastSeen
              ).length;
          });

          state.chats = chats;
      }

      // --- LOGIN ---
      function renderLogin() {
        if (state.currentUser) return;
        root.innerHTML = `
          <div class="min-h-screen bg-bipolar-darker flex flex-col items-center justify-center p-4 w-full">
            <div class="max-w-2xl w-full">
              <div class="text-center mb-12">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-4 tracking-tighter">Talken-C</h1>
                <p class="text-gray-400 text-lg">Encrypted. Private. Static.</p>
              </div>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-6 justify-center" id="login-grid"></div>
            </div>
          </div>
        `;

        const grid = document.getElementById('login-grid');
        const userList = Object.values(state.users).sort((a, b) => (a.created_at || 0) - (b.created_at || 0));

        userList.forEach(user => {
          const el = document.createElement('div');
          el.className = "group relative bg-gray-800 rounded-xl p-6 cursor-pointer hover:bg-gray-700 transition-all duration-300 transform hover:-translate-y-2 border border-gray-700 hover:border-gray-500 w-full flex flex-col items-center";
          el.onclick = () => promptLogin(user);
          el.innerHTML = `
            <div class="w-20 h-20 rounded-full mb-4 p-1 ${user.color || 'bg-gray-600'} bg-opacity-20">
              <img src="${getAvatar(user)}" loading="lazy" class="w-full h-full rounded-full object-cover border-2 border-white/10 group-hover:border-white/50 transition-colors" />
            </div>
            <h3 class="text-lg font-medium text-white group-hover:text-emerald-400 transition-colors text-center truncate w-full">${user.nickname || user.name}</h3>
          `;
          grid.appendChild(el);
        });
        
        const newEl = document.createElement('div');
        newEl.className = "group relative bg-gray-900 rounded-xl p-6 cursor-pointer hover:bg-gray-800 transition-all duration-300 transform hover:-translate-y-2 border-2 border-dashed border-gray-700 hover:border-emerald-500 w-full flex flex-col items-center justify-center min-h-[180px]";
        newEl.onclick = openNewUserModal;
        newEl.innerHTML = `
          <div class="w-16 h-16 rounded-full mb-4 bg-gray-800 flex items-center justify-center group-hover:bg-emerald-900/30 transition-colors">
            <svg class="w-8 h-8 text-gray-500 group-hover:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
          </div>
          <h3 class="text-lg font-medium text-gray-400 group-hover:text-white transition-colors">New User</h3>
        `;
        grid.appendChild(newEl);
      }

      function promptLogin(user) {
        if (!user.password) { handleLoginSuccess(user); return; }
        renderModal(`
          <div class="bg-gray-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-800">
            <h2 class="text-xl font-bold text-white mb-2">Login as ${user.nickname || user.name}</h2>
            <form id="login-form">
              <div class="mb-6"><input type="password" id="login-password" required placeholder="Password" class="w-full bg-gray-800 text-white rounded-lg px-4 py-3 border border-gray-700 focus:outline-none" /></div>
              <div class="flex justify-end gap-3"><button type="button" onclick="closeModal()" class="text-gray-400">Cancel</button><button type="submit" class="bg-emerald-600 text-white px-6 py-2 rounded-lg">Login</button></div>
            </form>
          </div>
        `);
        document.getElementById('login-form').onsubmit = (e) => {
          e.preventDefault();
          if (document.getElementById('login-password').value === user.password) { closeModal(); handleLoginSuccess(user); }
          else alert("Wrong password");
        };
      }

      function openNewUserModal() {
        renderModal(`
          <div class="bg-gray-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-800">
            <h2 class="text-xl font-bold text-white mb-4">Create New Identity</h2>
            <form id="new-user-form">
              <div class="mb-4"><label class="block text-sm text-gray-400 mb-2">Nickname</label><input type="text" id="new-nickname" maxlength="15" required class="w-full bg-gray-800 text-white rounded-lg px-4 py-3 border border-gray-700 focus:outline-none" /></div>
              <div class="mb-6"><label class="block text-sm text-gray-400 mb-2">Password</label><input type="password" id="new-password" required class="w-full bg-gray-800 text-white rounded-lg px-4 py-3 border border-gray-700 focus:outline-none" /></div>
              <div class="flex justify-end gap-3"><button type="button" onclick="closeModal()" class="text-gray-400">Cancel</button><button type="submit" class="bg-emerald-600 text-white px-6 py-2 rounded-lg">Create</button></div>
            </form>
          </div>
        `);
        document.getElementById('new-user-form').onsubmit = async (e) => {
           e.preventDefault();
           const name = document.getElementById('new-nickname').value.trim();
           const password = document.getElementById('new-password').value;
           if (!name || !password) return;
           const exists = Object.values(state.users).find(u => u.name.toLowerCase() === name.toLowerCase());
           if (exists) { alert('Name taken.'); return; }
           const newUser = await createNewUser(name, password);
           closeModal();
           handleLoginSuccess(newUser);
        };
      }

      function handleLoginSuccess(user) {
        state.currentUser = user;
        localStorage.setItem('bipolar_user_id', user.id);
        
        // 1. Subscribe to Groups LIST
        state.unsubs.push(subscribeToGroups((groups) => {
           state.groups = groups;
           
           // Subscribe to MESSAGES for each group I am in
           if (state.groupMessageUnsubs) {
               state.groupMessageUnsubs.forEach(u => u());
           }
           state.groupMessageUnsubs = [];
           state.rawGroups = {};

           Object.values(groups).forEach(g => {
              if (g.members && g.members.includes(state.currentUser.id)) {
                   const unsub = onValue(ref(db, `${ROOT_NODE}/groups/${g.id}/messages`), (s) => {
                       const mailbox = s.val() || {};
                       const flatMsgs = [];
                       Object.values(mailbox).forEach(week => {
                           Object.values(week).forEach(m => flatMsgs.push({
                             text: m.message,
                             sentBy: m.sent_by,
                             sentTo: m.sent_to,
                             timestamp: m.timestamp,
                             is_group: true
                           }));
                       });
                       state.rawGroups[g.id] = flatMsgs;
                       refreshUI();
                   });
                   state.groupMessageUnsubs.push(unsub);
              }
           });
           refreshUI();
        }));

        // 2. Subscribe to Wall
        state.unsubs.push(subscribeToWall((posts) => {
          state.wallPosts = posts;
          if (state.currentView === 'wall' && document.getElementById('wall-feed')) {
            renderWallPosts();
          }
        }));

        // 3. Subscribe to ALL Direct Messages (Global State)
        state.unsubs.push(subscribeToAllDMs(state.currentUser.id, (sent, received) => {
            state.rawDMs = { sent, received };
            refreshUI();
        }));

        // 4. Subscribe to My Read Status
        state.unsubs.push(subscribeToMyReadStatus(state.currentUser.id, (status) => {
            state.myReadStatus = status;
            refreshUI();
        }));

        initApp();
      }

      window.handleLogout = function() {
        state.unsubs.forEach(u => u());
        if(state.groupMessageUnsubs) state.groupMessageUnsubs.forEach(u => u());
        state.unsubs = [];
        state.groupMessageUnsubs = [];
        
        state.currentUser = null;
        state.selectedId = null;
        state.chats = {};
        state.rawDMs = null;
        state.rawGroups = null;

        localStorage.removeItem('bipolar_user_id');
        closeModal();
        renderLogin();
      }

      // --- MAIN APP ---
      function initApp() {
        renderAppStructure();
      }

      function selectItem(id, type) {
        state.selectedId = id;
        state.selectedType = type;
        state.currentView = 'chat';

        // Render UI first to show the chat immediately
        renderChatStructure(); 
        updateMobileLayout();
        renderSidebarList(); // Update selected highlight
        
        if (id) {
            renderChatMessages();
            // Mark as read without blocking the UI rendering
            setTimeout(() => {
                if(state.currentUser && id) {
                    try { markAsRead(state.currentUser.id, id); } catch(e) { console.warn(e); }
                }
            }, 50);
        }
      }

      function openWall() {
        state.currentView = 'wall';
        state.selectedId = null;
        updateMobileLayout();
        renderSidebarList(); // Keep sidebar visible but update selection state
        renderWallLayout();
        renderWallPosts();
      }

      // --- UI ---
      function renderAppStructure() {
        root.innerHTML = `
          <div class="flex w-full h-full bg-black overflow-hidden relative">
            <div id="sidebar" class="w-full md:w-80 lg:w-96 flex-none bg-bipolar-dark border-r border-gray-800 flex flex-col h-full z-20 absolute md:relative transition-transform duration-300">
              <!-- Header -->
              <div class="bg-gray-900 p-4 flex items-center justify-between border-b border-gray-800 h-16 flex-none">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openMyProfile()">
                  <img src="${getAvatar(state.currentUser)}" class="w-10 h-10 rounded-full bg-gray-800 object-cover" />
                  <div class="flex flex-col">
                    <span class="font-semibold text-gray-200 text-sm max-w-[100px] truncate">${state.currentUser.nickname || state.currentUser.name}</span>
                    <span class="text-[10px] text-emerald-500">Online</span>
                  </div>
                </div>
                <div class="flex gap-2">
                   <button onclick="openCircleModal()" class="p-2 rounded-full hover:bg-gray-800 text-gray-400 hover:text-white" title="New Circle">
                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                   </button>
                   <button onclick="openMyProfile()" class="p-2 rounded-full hover:bg-gray-800 text-gray-400 hover:text-white">
                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                   </button>
                </div>
              </div>
              
              <!-- Nav Tabs -->
              <div class="flex border-b border-gray-800">
                <button onclick="selectItem(null, null)" class="flex-1 py-3 text-sm font-medium ${state.currentView === 'chat' ? 'text-emerald-400 border-b-2 border-emerald-400' : 'text-gray-400 hover:text-white'}">Chats</button>
                <button onclick="openWall()" class="flex-1 py-3 text-sm font-medium ${state.currentView === 'wall' ? 'text-emerald-400 border-b-2 border-emerald-400' : 'text-gray-400 hover:text-white'}">Wall Doodles</button>
              </div>

              <div id="user-list" class="flex-1 overflow-y-auto"></div>
            </div>

            <div id="chat-area" class="flex-1 flex flex-col bg-gray-900 relative w-full h-full z-10 hidden md:flex">
               <!-- Chat or Wall injected here -->
            </div>
          </div>
        `;
        renderSidebarList();
        renderChatStructure();
      }

      function updateMobileLayout() {
        const sidebar = document.getElementById('sidebar');
        const chatArea = document.getElementById('chat-area');
        if (!sidebar || !chatArea) return; 

        if (window.innerWidth < 768) {
          if (state.selectedId || state.currentView === 'wall') {
            sidebar.classList.add('-translate-x-full');
            chatArea.classList.remove('hidden');
            chatArea.classList.add('flex');
          } else {
            sidebar.classList.remove('-translate-x-full');
            chatArea.classList.add('hidden');
            chatArea.classList.remove('flex');
          }
        }
      }

      function renderSidebarList() {
        const list = document.getElementById('user-list');
        if (!list) return;
        list.innerHTML = '';

        let allItems = [];

        // 1. Groups
        const myGroups = Object.values(state.groups).filter(g => g.members && g.members.includes(state.currentUser.id));
        myGroups.forEach(g => {
            allItems.push({ type: 'group', data: g, id: g.id });
        });

        // 2. Users
        const users = Object.values(state.users).filter(u => u.id !== state.currentUser.id);
        users.forEach(u => {
            allItems.push({ type: 'user', data: u, id: u.id });
        });

        // 3. Attach metadata (Last Message, Unread)
        allItems = allItems.map(item => {
            const chatData = state.chats[item.id] || { messages: [], lastMessage: null, unreadCount: 0 };
            return { ...item, ...chatData };
        });

        // 4. Sort by Last Message Timestamp (descending)
        allItems.sort((a, b) => {
            const tA = a.lastMessage ? a.lastMessage.timestamp : 0;
            const tB = b.lastMessage ? b.lastMessage.timestamp : 0;
            return tB - tA; // Newest first
        });

        allItems.forEach(item => {
           const isGroup = item.type === 'group';
           const data = item.data;
           const isSel = state.selectedId === item.id;
           
           const name = isGroup ? data.name : getDisplayName(data.id);
           const avatar = isGroup ? data.avatar : getAvatar(data);
           
           // Highlight logic for unread
           const unreadCount = item.unreadCount || 0;
           const hasUnread = unreadCount > 0;
           
           // Background: Selected > Unread (lightened) > Default
           let bgClass = 'hover:bg-gray-800/50 border-b border-gray-800/50';
           if (isSel) bgClass = 'bg-gray-800 border-b border-gray-800';
           else if (hasUnread) bgClass = 'bg-gray-800/40 border-b border-gray-800/50'; // Lightened slightly

           const lastMsgText = item.lastMessage ? (
               (item.lastMessage.sentBy === state.currentUser.id ? 'You: ' : '') + escapeHtml(item.lastMessage.text)
           ) : 'No messages';
           
           const lastMsgTime = item.lastMessage ? formatTime(item.lastMessage.timestamp) : '';
           const unreadBadge = hasUnread ? `<div class="bg-unread-badge text-black font-bold rounded-full min-w-[1.25rem] h-5 flex items-center justify-center text-xs px-1.5 shadow-sm">${unreadCount}</div>` : '';
           
           // Extra icons
           const isAliased = !isGroup && name !== (data.nickname || data.name);
           const aliasIcon = isAliased ? '<span class="ml-1 text-xs text-yellow-500 opacity-70">✎</span>' : '';
           
           const el = document.createElement('div');
           el.className = `flex items-center p-3 cursor-pointer transition-colors duration-200 ${bgClass}`;
           el.onclick = () => selectItem(item.id, item.type);

           el.innerHTML = `
             <div class="relative flex-none">
                 <img src="${avatar}" class="w-12 h-12 ${isGroup?'rounded-lg':'rounded-full'} object-cover bg-gray-700" />
             </div>
             <div class="ml-3 flex-1 min-w-0">
               <div class="flex justify-between items-baseline mb-0.5">
                  <h3 class="text-gray-200 font-medium truncate text-[15px] ${hasUnread ? 'font-semibold text-white' : ''}">${escapeHtml(name)} ${aliasIcon}</h3>
                  <span class="text-xs ${hasUnread ? 'text-emerald-400 font-medium' : 'text-gray-500'} flex-none ml-2">${lastMsgTime}</span>
               </div>
               <div class="flex justify-between items-center">
                  <p class="text-xs truncate max-w-[85%] ${hasUnread ? 'text-gray-300 font-medium' : 'text-gray-500'}">${lastMsgText}</p>
                  ${unreadBadge}
               </div>
             </div>
           `;
           list.appendChild(el);
        });
      }

      function updateChatBackground() {
          const container = document.getElementById('messages-container');
          if(!container || !state.selectedId) return;

          const isUser = state.selectedType === 'user';
          let bgUrl = THEMES['classic'].url;
          
          if (isUser) {
              const prefs = state.currentUser.preferences?.[state.selectedId] || {};
              const themeKey = prefs.theme || 'classic';
              if(THEMES[themeKey]) bgUrl = THEMES[themeKey].url;
          } else {
             // Groups default
             bgUrl = THEMES['classic'].url;
          }
          
          container.style.backgroundImage = `url('${bgUrl}')`;
          container.style.backgroundColor = 'transparent'; // Ensure no conflict
      }

      // --- WALL RENDERER (Split for responsiveness) ---
      function renderWallLayout() {
        const area = document.getElementById('chat-area');
        if (!area) return;
        area.innerHTML = `
           <div class="h-16 bg-gray-800 border-b border-gray-700 flex items-center px-4 justify-between flex-none">
             <div class="flex items-center gap-3">
               <button onclick="state.currentView='chat'; updateMobileLayout(); renderSidebarList();" class="md:hidden text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
               <h2 class="text-xl font-bold text-white">Public Wall Doodles</h2>
             </div>
           </div>
           
           <div class="flex-1 overflow-y-auto p-4 space-y-4" id="wall-feed" style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');">
              <!-- Posts Injected via renderWallPosts -->
           </div>

           <div class="bg-gray-800 p-4 flex gap-2">
             <input type="text" id="wall-input" placeholder="Doodle something public..." class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none" />
             <button onclick="handleWallPost()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg">Post</button>
           </div>
        `;
        // Handle input enter key
        const inp = document.getElementById('wall-input');
        if(inp) inp.onkeydown = (e) => { if(e.key === 'Enter') handleWallPost(); };
      }

      function renderWallPosts() {
        const feed = document.getElementById('wall-feed');
        if(!feed) return; // Layout not ready

        // Clear existing posts
        feed.innerHTML = '';

        if(state.wallPosts.length === 0) {
            feed.innerHTML = `<div class="text-center text-gray-500 mt-10">No doodles yet. Be the first!</div>`;
        } else {
            state.wallPosts.forEach(post => {
                const u = state.users[post.user_id];
                if(!u) return;
                const div = document.createElement('div');
                div.className = "glass-panel p-4 rounded-xl wall-post flex gap-3";
                div.innerHTML = `
                  <img src="${getAvatar(u)}" loading="lazy" class="w-10 h-10 rounded-full object-cover" />
                  <div>
                    <div class="flex items-baseline gap-2">
                       <span class="font-bold text-emerald-400">${getDisplayName(post.user_id)}</span>
                       <span class="text-xs text-gray-500">${formatTime(post.timestamp)}</span>
                    </div>
                    <p class="text-gray-200 mt-1">${escapeHtml(post.text)}</p>
                  </div>
                `;
                feed.appendChild(div);
            });
        }
      }

      window.handleWallPost = async function() {
         const inp = document.getElementById('wall-input');
         const txt = inp.value.trim();
         if(!txt) return;
         inp.value = '';
         await postToWall(state.currentUser.id, txt);
      }

      // --- CHAT RENDERER ---
      function renderChatStructure() {
        if (state.currentView === 'wall') return; 
        
        const area = document.getElementById('chat-area');
        if (!area) return;

        if (!state.selectedId) {
           area.innerHTML = `
            <div class="flex-1 flex flex-col items-center justify-center text-center p-8 bg-gray-900">
               <div class="w-64 h-64 rounded-xl overflow-hidden mb-6 shadow-2xl transform rotate-3 transition hover:rotate-0 duration-500 bg-gray-800">
                  <img src="https://picsum.photos/seed/talkenc/600/600" class="w-full h-full object-cover" />
               </div>
               <h2 class="text-2xl text-white font-light">Welcome back, ${state.currentUser.nickname || state.currentUser.name}</h2>
               <p class="text-gray-500 mt-2">Select a friend or circle to start chatting.</p>
            </div>`;
           return;
        }

        const isUser = state.selectedType === 'user';
        const target = isUser ? state.users[state.selectedId] : state.groups[state.selectedId];
        
        if(!target) { state.selectedId = null; return renderChatStructure(); } // Deletion guard

        const title = isUser ? getDisplayName(target.id) : target.name;
        const sub = isUser ? 'User' : `${target.members.length} members`;
        const clickAction = isUser ? 'openFriendProfile()' : 'openGroupProfile()';

        area.innerHTML = `
          <div class="h-16 bg-gray-800 border-b border-gray-700 flex items-center px-4 justify-between z-10 flex-none shadow-md">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="${clickAction}">
              <button onclick="selectItem(null,null)" class="md:hidden text-white stop-prop"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
              <img src="${isUser ? getAvatar(target) : target.avatar}" class="w-10 h-10 ${isUser?'rounded-full':'rounded-lg'} object-cover group-hover:opacity-80 transition" />
              <div>
                 <h3 class="text-white font-semibold group-hover:text-emerald-400 transition">${escapeHtml(title)}</h3>
                 <p class="text-xs text-gray-400">${sub}</p>
              </div>
            </div>
            <button onclick="${clickAction}" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
          </div>
          <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-1 bg-black/40"></div>
          <div class="bg-gray-800 p-3 flex gap-2">
             <input type="text" id="msg-input" class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none" placeholder="Message..." autocomplete="off">
             <button onclick="triggerSend()" class="text-emerald-500"><svg class="w-6 h-6 transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button>
          </div>
        `;
        
        updateChatBackground();
        
        const inp = document.getElementById('msg-input');
        if(inp) {
            inp.onkeydown = (e) => { if(e.key === 'Enter') triggerSend(); };
            if (window.innerWidth >= 768) inp.focus();
        }
        
        const back = document.querySelector('.stop-prop');
        if(back) back.onclick = (e) => { e.stopPropagation(); selectItem(null,null); }
      }

      window.triggerSend = async function() {
         const inp = document.getElementById('msg-input');
         const txt = inp.value.trim();
         if(!txt) return;
         inp.value = '';
         
         if(state.selectedType === 'user') {
            await sendMessage(state.currentUser.id, state.selectedId, txt);
         } else {
            await sendGroupMessage(state.currentUser.id, state.selectedId, txt);
         }
      }

      function renderChatMessages() {
        const container = document.getElementById('messages-container');
        if (!container || !state.selectedId) return;

        const chatData = state.chats[state.selectedId];
        const messages = chatData ? chatData.messages : [];

        let lastDate = '';
        let html = '';

        messages.forEach(msg => {
           const d = formatMessageDate(msg.timestamp);
           if(d !== lastDate) {
              html += `<div class="flex justify-center my-4"><span class="bg-gray-800 text-gray-400 text-xs py-1 px-3 rounded-full shadow-sm">${d}</span></div>`;
              lastDate = d;
           }
           
           const isMe = msg.sentBy === state.currentUser.id;
           const isGroup = state.selectedType === 'group';
           const sender = state.users[msg.sentBy];
           const senderName = sender ? getDisplayName(msg.sentBy) : 'Unknown';
           
           // Simple tick logic (if message is in list, it's sent. "Read" logic is complex in sidebar, simple here)
           let ticks = '';
           if(isMe && !isGroup) {
              // We could check against partner's last seen, but we don't subscribe to partner status globally for perf.
              // We'll leave ticks simple or omit for now to stick to "static-like" simplicity requested, or simple double check.
              ticks = `<span class="ml-1 text-blue-400 text-xs">✓✓</span>`;
           }
           
           const bubbleClass = isMe ? 'bg-chat-sent text-white rounded-tr-none' : 'bg-chat-received text-white rounded-tl-none';

           html += `
             <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-1 group">
               ${(!isMe && isGroup) ? `<img src="${sender ? getAvatar(sender) : ''}" loading="lazy" class="w-6 h-6 rounded-full mr-2 self-end mb-1"/>` : ''}
               <div class="relative max-w-[80%] px-4 py-2 rounded-xl text-sm shadow-md ${bubbleClass}">
                 ${(!isMe && isGroup) ? `<p class="text-[10px] text-emerald-400 mb-0.5 font-bold">${escapeHtml(senderName)}</p>` : ''}
                 <p class="leading-relaxed break-words text-[15px]">${escapeHtml(msg.text)}</p>
                 <div class="text-[10px] text-right opacity-70 mt-1">${formatTime(msg.timestamp)} ${ticks}</div>
               </div>
             </div>
           `;
        });
        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
      }

      // --- MODALS ---
      window.openCircleModal = function() {
        const friends = Object.values(state.users).filter(u => u.id !== state.currentUser.id);
        const checks = friends.map(f => `
          <label class="flex items-center p-2 hover:bg-gray-800 rounded cursor-pointer justify-between group">
             <div class="flex items-center">
                 <img src="${getAvatar(f)}" class="w-8 h-8 rounded-full mr-3 object-cover">
                 <span class="text-gray-300 text-sm group-hover:text-white">${getDisplayName(f.id)}</span>
             </div>
             <div class="relative">
                 <input type="checkbox" value="${f.id}" class="custom-checkbox appearance-none w-5 h-5 border-2 border-gray-600 rounded cursor-pointer checked:bg-emerald-600 checked:border-emerald-600 circle-member-check">
                 <div class="absolute inset-0 hidden pointer-events-none items-center justify-center text-white">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"/></svg>
                 </div>
             </div>
          </label>
        `).join('');

        renderModal(`
           <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 border border-gray-800">
              <h2 class="text-xl font-bold text-white mb-4">Create New Circle</h2>
              <input id="circle-name" type="text" placeholder="Circle Name" class="w-full bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700 mb-4 focus:outline-none focus:border-emerald-500" />
              <div class="max-h-60 overflow-y-auto space-y-1 mb-6 pr-2">${checks}</div>
              <div class="flex justify-end gap-3"><button onclick="closeModal()" class="text-gray-400 hover:text-white px-3">Cancel</button><button onclick="handleCreateCircle()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-medium">Create</button></div>
           </div>
        `);
      }

      window.handleCreateCircle = async function() {
         const name = document.getElementById('circle-name').value.trim();
         const checks = document.querySelectorAll('.circle-member-check:checked');
         const ids = Array.from(checks).map(c => c.value);
         if(!name || ids.length === 0) return alert("Name and at least 1 friend required");
         await createCircle(name, state.currentUser.id, ids);
         closeModal();
      }

      window.openGroupProfile = function() {
        if (!state.selectedId || state.selectedType !== 'group') return;
        const group = state.groups[state.selectedId];
        const isCreator = group.created_by === state.currentUser.id;
        
        const membersHtml = group.members.map(mid => {
           const u = state.users[mid];
           if(!u) return '';
           return `<div class="flex items-center gap-2 mb-2 p-2 bg-gray-800/50 rounded-lg">
              <img src="${getAvatar(u)}" class="w-6 h-6 rounded-full object-cover">
              <span class="text-gray-300 text-sm">${getDisplayName(mid)}</span>
           </div>`;
        }).join('');

        const friendsNotInGroup = Object.values(state.users).filter(u => !group.members.includes(u.id));
        const addOptions = friendsNotInGroup.map(f => `<option value="${f.id}">${getDisplayName(f.id)}</option>`).join('');

        renderModal(`
           <div class="bg-gray-900 w-full max-w-sm rounded-2xl p-6 border border-gray-800">
              <div class="flex items-center justify-between mb-6">
                 <h2 class="text-xl font-bold text-white">Circle Info</h2>
                 <button onclick="closeModal()" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
              </div>
              
              <div class="mb-6">
                 <label class="block text-xs text-gray-500 mb-1 uppercase tracking-wider font-semibold">Circle Name</label>
                 <div class="flex gap-2">
                   <input id="edit-group-name" type="text" value="${escapeHtml(group.name)}" class="flex-1 bg-gray-800 text-white rounded-lg px-3 py-2 border border-gray-700 text-sm focus:outline-none focus:border-emerald-500" />
                   <button onclick="handleRenameGroup()" class="bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm">Save</button>
                 </div>
              </div>

              <div class="mb-6">
                 <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wider font-semibold">Members (${group.members.length})</label>
                 <div class="max-h-40 overflow-y-auto mb-2 custom-scrollbar">
                    ${membersHtml}
                 </div>
                 
                 ${friendsNotInGroup.length > 0 ? `
                 <div class="flex gap-2 mt-2">
                    <select id="add-member-select" class="flex-1 bg-gray-800 text-white rounded-lg px-2 py-2 border border-gray-700 text-sm focus:outline-none">
                       ${addOptions}
                    </select>
                    <button onclick="handleAddMember()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm">Add</button>
                 </div>` : ''}
              </div>

              ${isCreator ? `
              <div class="border-t border-gray-800 pt-4 mt-4">
                  <button onclick="handleDeleteGroup()" class="w-full bg-red-900/30 hover:bg-red-900/50 text-red-300 py-3 rounded-lg text-sm transition border border-red-900/50">Delete Circle</button>
              </div>` : ''}
           </div>
        `);

        window.handleRenameGroup = async () => {
           const newName = document.getElementById('edit-group-name').value.trim();
           if(newName && newName !== group.name) {
              await updateGroupName(group.id, newName);
              closeModal();
           }
        };

        window.handleAddMember = async () => {
           const newMemberId = document.getElementById('add-member-select').value;
           if(newMemberId) {
              const newMembers = [...group.members, newMemberId];
              await updateGroupMembers(group.id, newMembers);
              closeModal();
           }
        };

        window.handleDeleteGroup = async () => {
           if(confirm("Are you sure you want to delete this circle? Messages will be lost.")) {
              await deleteCircle(group.id);
              state.selectedId = null;
              closeModal();
              refreshUI();
           }
        }
      }

      window.openMyProfile = function() {
        const myProfile = state.users[state.currentUser.id];
        const friends = Object.values(state.users).filter(u => u.id !== state.currentUser.id);
        const bestieOptions = friends.map(f => `<option value="${f.id}" ${myProfile.bestie_id === f.id ? 'selected' : ''}>${getDisplayName(f.id)}</option>`).join('');
        
        renderModal(`
          <div class="bg-gray-900 w-full max-w-md rounded-2xl p-6 shadow-2xl border border-gray-800">
            <h2 class="text-xl font-bold text-white mb-6">Edit Profile</h2>
            <form id="profile-form" class="space-y-4">
              <div><label class="block text-sm text-gray-400 mb-1">Nickname (Public)</label>
              <input type="text" id="input-nick" value="${escapeHtml(myProfile.nickname || myProfile.name)}" class="w-full bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700 focus:outline-none focus:border-emerald-500" /></div>
              
              <div><label class="block text-sm text-gray-400 mb-1">Status Note</label>
              <input type="text" id="input-note" maxlength="30" value="${escapeHtml(myProfile.note || '')}" class="w-full bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700 focus:outline-none focus:border-emerald-500" /></div>

              <div><label class="block text-sm text-gray-400 mb-1">About</label>
              <textarea id="input-about" rows="3" class="w-full bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700 focus:outline-none focus:border-emerald-500">${escapeHtml(myProfile.about || '')}</textarea></div>

              <div><label class="block text-sm text-gray-400 mb-1">My Bestie ❤️</label>
              <select id="input-bestie" class="w-full bg-gray-800 text-white rounded-lg px-4 py-2 border border-gray-700 focus:outline-none focus:border-emerald-500">
                 <option value="">-- None --</option>
                 ${bestieOptions}
              </select></div>

              <div class="pt-4 flex justify-between">
                 <button type="button" onclick="handleLogout()" class="text-red-400 text-sm hover:text-red-300">Logout</button>
                 <button type="submit" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-medium">Save</button>
              </div>
            </form>
          </div>
        `);

        document.getElementById('profile-form').onsubmit = (e) => {
           e.preventDefault();
           updateUserProfile(state.currentUser.id, {
              nickname: document.getElementById('input-nick').value.trim(),
              note: document.getElementById('input-note').value.trim(),
              about: document.getElementById('input-about').value.trim(),
              bestie_id: document.getElementById('input-bestie').value
           });
           closeModal();
        };
      }

      window.openFriendProfile = function() {
        if(!state.selectedId || state.selectedType !== 'user') return;
        const user = state.users[state.selectedId];
        const isMyBestie = state.currentUser.bestie_id === user.id;
        const theyAreBestieWith = user.bestie_id ? (state.users[user.bestie_id]?.nickname || state.users[user.bestie_id]?.name) : null;
        
        const prefs = state.currentUser.preferences?.[user.id] || {};
        const currentAlias = prefs.alias || '';
        const currentTheme = prefs.theme || 'classic';

        // Theme Options
        const themeOptions = Object.keys(THEMES).map(key => {
            const t = THEMES[key];
            const isSel = currentTheme === key;
            return `
               <div class="cursor-pointer border-2 ${isSel ? 'border-emerald-500 ring-2 ring-emerald-500/20' : 'border-gray-700'} rounded-lg overflow-hidden relative" onclick="selectTheme('${key}', this)">
                   <div class="h-16 w-full bg-gray-800" style="background-image: url('${t.url}'); background-size: 100px;"></div>
                   <div class="p-2 text-center text-xs text-white bg-gray-900">${t.name}</div>
                   ${isSel ? '<div class="absolute top-1 right-1 text-emerald-500 bg-white rounded-full p-0.5"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>' : ''}
               </div>
            `;
        }).join('');

        renderModal(`
           <div class="bg-gray-900 w-full max-w-sm rounded-2xl p-6 border border-gray-800 flex flex-col items-center relative max-h-[90vh] overflow-y-auto">
              <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
              <img src="${getAvatar(user)}" class="w-24 h-24 rounded-full border-4 border-gray-800 shadow-lg object-cover mb-4" />
              <h2 class="text-2xl font-bold text-white mb-1">${escapeHtml(getDisplayName(user.id))}</h2>
              <p class="text-xs text-gray-500 mb-2">Original: ${escapeHtml(user.nickname || user.name)}</p>

              ${isMyBestie ? '<span class="bg-pink-900/50 text-pink-400 text-xs px-2 py-1 rounded-full mb-2">❤️ Your Bestie</span>' : ''}
              ${theyAreBestieWith ? `<p class="text-xs text-gray-500 mb-4">Besties with ${theyAreBestieWith}</p>` : ''}
              
              <div class="w-full bg-gray-800/50 rounded-xl p-4 text-left mb-4">
                <h3 class="text-xs text-gray-500 font-semibold mb-2">ABOUT</h3>
                <p class="text-gray-300 text-sm">${escapeHtml(user.about || 'No info.')}</p>
              </div>

              <div class="w-full bg-gray-800 rounded-xl p-4 text-left">
                  <h3 class="text-xs text-gray-400 font-semibold mb-3 uppercase tracking-wider">Chat Settings</h3>
                  
                  <div class="mb-4">
                     <label class="text-xs text-gray-500 block mb-1">Set Alias</label>
                     <input id="pref-alias" type="text" value="${escapeHtml(currentAlias)}" placeholder="e.g. My Pookie" class="w-full bg-gray-700 text-white text-sm rounded-lg px-3 py-2 border border-gray-600 focus:outline-none focus:border-emerald-500" />
                  </div>

                  <div class="mb-2">
                     <label class="text-xs text-gray-500 block mb-2">Chat Theme</label>
                     <div class="grid grid-cols-2 gap-3" id="theme-grid">
                        ${themeOptions}
                     </div>
                     <input type="hidden" id="selected-theme" value="${currentTheme}" />
                  </div>

                  <button onclick="handleSavePrefs()" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-500 text-white text-sm py-2 rounded-lg transition font-medium">Save Preferences</button>
              </div>
           </div>
        `);

        // Global function for theme selection click handling
        window.selectTheme = (key, el) => {
             document.getElementById('selected-theme').value = key;
             // Visual selection update
             const grid = document.getElementById('theme-grid');
             Array.from(grid.children).forEach(child => {
                 child.classList.remove('border-emerald-500', 'ring-2', 'ring-emerald-500/20');
                 child.classList.add('border-gray-700');
                 // Remove checkmark
                 const tick = child.querySelector('.absolute');
                 if(tick) tick.remove();
             });
             
             el.classList.remove('border-gray-700');
             el.classList.add('border-emerald-500', 'ring-2', 'ring-emerald-500/20');
             el.innerHTML += '<div class="absolute top-1 right-1 text-emerald-500 bg-white rounded-full p-0.5"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div>';
        };

        window.handleSavePrefs = async () => {
           const alias = document.getElementById('pref-alias').value.trim();
           const theme = document.getElementById('selected-theme').value;
           
           // Optimistic update for immediate feedback
           if (!state.currentUser.preferences) state.currentUser.preferences = {};
           state.currentUser.preferences[user.id] = { alias, theme };
           
           await updateUserPreferences(state.currentUser.id, user.id, {
               alias: alias,
               theme: theme
           });
           closeModal();
           refreshUI();
        }
      }

      function renderModal(content) {
        modalContainer.innerHTML = `<div class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onclick="if(event.target === this) closeModal()"><div class="transform transition-all duration-300 scale-100 opacity-100 w-full max-w-md max-h-[95vh] overflow-y-auto">${content}</div></div>`;
      }
      window.closeModal = function() { modalContainer.innerHTML = ''; }
      function escapeHtml(text) { if (!text) return ""; return text.replace(/[&<>"']/g, function(m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]; }); }
      window.addEventListener('resize', updateMobileLayout);

      // Attach global functions that are used in HTML attributes
      window.openWall = openWall;
      window.selectItem = selectItem;
      window.promptLogin = promptLogin;
      window.openNewUserModal = openNewUserModal;
    </script>
  </body>
</html>
